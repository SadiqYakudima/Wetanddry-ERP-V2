// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Fleet Management Module

model Truck {
  id              String    @id @default(cuid())
  plateNumber     String    @unique
  model           String
  capacity        String    // e.g., "8mÂ³"
  status          String    @default("Available") // Available, In Use, Maintenance
  purchaseDate    DateTime
  mileage         Int       @default(0)
  lastServiceDate DateTime?
  nextServiceDate DateTime?
  nextServiceMileage Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  maintenanceRecords MaintenanceRecord[]
  maintenanceSchedules MaintenanceSchedule[]
  parts              Part[]
  fuelLogs           FuelLog[]
  exceptionLogs      ExceptionLog[]
  documents          TruckDocument[]
}

model TruckDocument {
  id               String   @id @default(cuid())
  truckId          String
  truck            Truck    @relation(fields: [truckId], references: [id], onDelete: Cascade)
  name             String
  type             String   // "Registration", "Insurance", "Inspection", "Maintenance", "Other"
  url              String
  cloudinaryPublicId String
  expiryDate       DateTime?
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model MaintenanceRecord {
  id          String   @id @default(cuid())
  truckId     String
  truck       Truck    @relation(fields: [truckId], references: [id], onDelete: Cascade)
  date        DateTime
  type        String   // e.g., Oil Change, Tire Replacement
  cost        Float
  mileageAtService Int?
  status      String   @default("Completed") // Completed, Scheduled, Overdue
  notes       String?
  performedBy String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Maintenance Scheduler - Automated alerts for service intervals
model MaintenanceSchedule {
  id              String   @id @default(cuid())
  truckId         String
  truck           Truck    @relation(fields: [truckId], references: [id], onDelete: Cascade)
  type            String   // e.g., Oil Change, Brake Inspection, Full Service
  intervalType    String   // "date" or "mileage" or "both"
  intervalDays    Int?     // e.g., 90 days
  intervalMileage Int?     // e.g., 10000 km
  nextDueDate     DateTime?
  nextDueMileage  Int?
  lastCompletedDate DateTime?
  isActive        Boolean  @default(true)
  priority        String   @default("Normal") // Low, Normal, High, Critical
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Component Lifecycle Tracking - For high-wear components (Tires, Batteries)
model Part {
  id              String   @id @default(cuid())
  truckId         String
  truck           Truck    @relation(fields: [truckId], references: [id], onDelete: Cascade)
  partNumber      String
  name            String
  category        String   // e.g., Tire, Battery, Brake Pad, Filter
  position        String?  // e.g., Front Left, Rear Right, Engine Bay
  installedDate   DateTime
  lifespanMonths  Int      // Expected lifespan in months
  lifespanMileage Int?     // Expected lifespan in kilometers
  mileageAtInstall Int?    // Truck mileage when part was installed
  expectedReplacementDate DateTime?
  purchasePrice   Float?
  supplier        String?
  warrantyExpiry  DateTime?
  status          String   @default("Active") // Active, Due for Replacement, Replaced
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Spare Parts Inventory - Track spare parts by Part Number, Purchase Price, Quantity
model SparePartInventory {
  id            String   @id @default(cuid())
  partNumber    String   @unique
  name          String
  category      String   // e.g., Tire, Battery, Filter, Brake Pad
  description   String?
  quantity      Int      @default(0)
  minQuantity   Int      @default(1) // Threshold for low stock alert
  purchasePrice Float
  supplier      String?
  location      String?  // Storage location
  lastRestocked DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Inventory Management Module

model StorageLocation {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "Silo 1", "Silo 2", "Main Warehouse"
  type        String   // e.g., "Silo", "Warehouse", "Shelf"
  description String?
  capacity    Float?   // Maximum capacity (for silos, in kg)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items          InventoryItem[]
  productionRuns ProductionRun[]
}

model InventoryItem {
  id              String   @id @default(cuid())
  name            String
  sku             String?
  category        String   // "Asset", "Consumable", "Equipment"
  itemType        String   @default("General") // e.g., "Cement", "Aggregate", "Admixture", "General"
  quantity        Float    @default(0)
  maxCapacity     Float?   // Maximum storage capacity (for silos)
  unit            String   // e.g., "kg", "liters", "pcs"
  minThreshold    Float    @default(0)
  unitCost        Float    @default(0)  // Cost per unit
  totalValue      Float    @default(0)  // Calculated: quantity * unitCost
  expiryDate      DateTime?
  batchNumber     String?  // For traceability
  supplier        String?
  recipeIngredients RecipeIngredient[] // Relation to recipes
  
  locationId      String
  location        StorageLocation @relation(fields: [locationId], references: [id])
  
  transactions    StockTransaction[]
  materialRequests MaterialRequest[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model StockTransaction {
  id          String   @id @default(cuid())
  itemId      String
  item        InventoryItem @relation(fields: [itemId], references: [id])
  type        String   // "IN", "OUT", "ADJUSTMENT"
  quantity    Float
  reason      String?
  status      String   @default("Pending") // "Pending", "Approved", "Rejected"
  performedBy String?  // User ID or Name
  approvedBy  String?  // Approver for the transaction
  approvedAt  DateTime?
  notes       String?
  createdAt   DateTime @default(now())
}

// Material Request Workflow - For approval process
model MaterialRequest {
  id              String   @id @default(cuid())
  requestType     String   // "Stock In", "Stock Out", "Transfer"
  itemId          String
  item            InventoryItem @relation(fields: [itemId], references: [id])
  quantity        Float
  fromLocationId  String?  // For transfers
  toLocationId    String?  // For transfers
  reason          String?
  priority        String   @default("Normal") // "Low", "Normal", "High", "Urgent"
  status          String   @default("Pending") // "Pending", "Approved", "Rejected", "Completed"
  requestedBy     String
  approvedBy      String?
  approvedAt      DateTime?
  completedAt     DateTime?
  rejectionReason String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Production & Mixology Module

model Recipe {
  id          String   @id @default(cuid())
  productCode String   @unique // e.g. "C10", "C15"
  name        String   // e.g., "Standard Concrete (C25)"
  description String?
  totalWeight Float    @default(0) // Auto-calculated total batch weight
  ingredients RecipeIngredient[]
  runs        ProductionRun[]
  exceptionLogs ExceptionLog[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model RecipeIngredient {
  id           String   @id @default(cuid())
  recipeId     String
  recipe       Recipe   @relation(fields: [recipeId], references: [id])
  inventoryItemId String
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])
  materialName String   // Cached name or specific role (e.g. "20mm Aggregate")
  quantity     Float    // Amount required per 1 unit of production
  unit         String   // e.g., "kg"
}

model ProductionRun {
  id          String   @id @default(cuid())
  recipeId    String
  recipe      Recipe   @relation(fields: [recipeId], references: [id])
  siloId      String?  // Which silo the cement was drawn from
  silo        StorageLocation? @relation(fields: [siloId], references: [id])
  quantity    Float    // Amount produced
  cementUsed  Float?   // Amount of cement deducted from silo (kg)
  status      String   @default("Completed")
  notes       String?
  operatorName String?
  createdAt   DateTime @default(now())
}

// Diesel & Fuel Intelligence Module

model FuelLog {
  id          String   @id @default(cuid())
  truckId     String
  truck       Truck    @relation(fields: [truckId], references: [id])
  date        DateTime @default(now())
  liters      Float
  cost        Float
  mileage     Int      // Mileage at time of fueling
  efficiency  Float?   // Calculated km/L
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Exception Handling Module (Dump & Divert)

model ExceptionLog {
  id          String   @id @default(cuid())
  type        String   // "Dump" or "Divert"
  reason      String   // e.g., "Bad Mix", "Truck Breakdown", "Client Rejection"
  quantity    Float    // Amount wasted/diverted
  unit        String   // e.g., "m3"
  
  truckId     String?
  truck       Truck?   @relation(fields: [truckId], references: [id])
  
  recipeId    String?
  recipe      Recipe?  @relation(fields: [recipeId], references: [id])

  notes       String?
  reportedBy  String?
  resolved    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// User Management Module

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      String   // "Super Admin", "Operations Manager", "Storekeeper", "Accountant", "Driver"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Staff Registry Module

model Staff {
  id          String   @id @default(cuid())
  firstName   String
  lastName    String
  role        String
  department  String
  email       String?
  phone       String
  address     String
  status      String   @default("Active") // Active, On Leave, Terminated, Contract
  joinedDate  DateTime
  
  documents   StaffDocument[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model StaffDocument {
  id               String   @id @default(cuid())
  staffId          String
  staff            Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  name             String
  type             String   // "ID", "Contract", "Agreement", "Other"
  url              String
  cloudinaryPublicId String
  expiryDate       DateTime?
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}
